# openOBD Protocol

This is the Jifeline Networks `openOBD` protocol. It uses [gRPC](https://grpc.io/) (which in turn uses[Protobuf](https://protobuf.dev/))
to define a protocol in a language agnostic way. Using `gRPC` and `Protobuf` you can compile the `openOBD` protocol to a 
[supported language](https://grpc.io/docs/#official-support) and interact with the Jifeline infrastructure to remotely program cars.

> [!Note]
> Jifeline Networks supplies a precompiled version of the `openOBD` protocol for both [Python](https://pypi.org/project/openobd-protocol/) and [Java](https://mvnrepository.com/artifact/com.jifeline/OpenOBD).

Below we will describe how to use `gRPC` and Protobuf to generate a library in a few different languages as an example. Please 
refer to the `gRPC` documentation on how to compile to any other languages. Note that all our examples use `gRPC` version `1.61.0`

## `Python`

`gRPC` uses **Python 3** so ensure you have a compatible version installed. For this example we will use [pipenv](https://pipenv.pypa.io/en/latest/)
to manage our dependencies.

First make sure your folder structure looks like this:

```
openOBD-example/        # You'll execute the commands in this folder
  output/               # Create this folder yourself
  v1/                   # This is the proto/v1 folder from this project
    Communication/
    Configuration/
    ...
  Pipfile               # Will be generated by pipenv
  Pipfile.lock          # Will be generated by pipenv
```

Then install the gRPC dependencies on your system.

```bash
pipenv install grpcio grpcio-tools
```

Now you can generate the `Python` files by first compiling the `Protobuf` definitions after which you can also generate the 
`gRPC` services. Note that this is all done within the _shell_ (execute `pipenv shell` to go into this shell) you created 
in the previous step.

```bash
find -name "*.proto" -exec python -m grpc_tools.protoc --proto_path=. --python_out=./output --pyi_out=./output "{}" \;
find -name "*Services.proto" -exec python -m grpc_tools.protoc --proto_path=. --python_out=./output --pyi_out=./output --grpc_python_out=./output "{}" \;
```

You `output` folder should now contain the `Python` files necessary to use the `openOBD` protocol in you project!

## `Java`

`gRPC-java` uses **Java 8 and higher** so ensure you have a compatible version installed. For this example we will use [Maven](https://maven.apache.org/)
to manage our dependencies and as a build tool.

Create a `Maven` project and add the following dependencies to your `pom` file (supplying a valid `grpc.version` in your properties 
definitions)

```xml
<dependency>
  <groupId>io.grpc</groupId>
  <artifactId>grpc-netty-shaded</artifactId>
  <version>${grpc.version}</version>
  <scope>runtime</scope>
</dependency>
<dependency>
  <groupId>io.grpc</groupId>
  <artifactId>grpc-protobuf</artifactId>
  <version>${grpc.version}</version>
</dependency>
<dependency>
  <groupId>io.grpc</groupId>
  <artifactId>grpc-stub</artifactId>
  <version>${grpc.version}</version>
</dependency>
```

If you use **Java 9 or higher** you also need an extra dependency (otherwise you'll get compilation errors 
concerning some annotations)

```xml
<!-- necessary for Java 9+ -->
<dependency>
    <groupId>org.apache.tomcat</groupId>
    <artifactId>annotations-api</artifactId>
    <version>6.0.53</version> <!-- Recommended by gRPC-java even though it's quite old, and it even moved -->
    <scope>provided</scope>
</dependency>
```

Then, to be able to compile the proto files, add the following build configuration to your `pom` file

```xml
<build>
  <extensions>
    <extension>
      <groupId>kr.motd.maven</groupId>
      <artifactId>os-maven-plugin</artifactId>
      <version>1.7.1</version>
    </extension>
  </extensions>
  <plugins>
    <plugin>
      <groupId>org.xolstice.maven.plugins</groupId>
      <artifactId>protobuf-maven-plugin</artifactId>
      <version>0.6.1</version>
      <configuration>
        <protocArtifact>com.google.protobuf:protoc:3.25.5:exe:${os.detected.classifier}</protocArtifact>
        <pluginId>grpc-java</pluginId>
        <pluginArtifact>io.grpc:protoc-gen-grpc-java:${grpc.version}:exe:${os.detected.classifier}</pluginArtifact>
      </configuration>
      <executions>
        <execution>
          <goals>
            <goal>compile</goal>
            <goal>compile-custom</goal>
          </goals>
        </execution>
      </executions>
    </plugin>
  </plugins>
</build>
```

Next just add the `proto` folder containing all the `openOBD` proto definitions to your project, these will be compiled 
whenever you compile your project. 

Just for reference your project folder structure should look something like this

```
openOBD-example/            # The Maven project folder, name this as you'd like
  src/
    main/
      java/
        org.example/        # This is your code
      proto/                # This is the proto folder from this project
        v1/
          Communication/
          Configuration/
          ..
    test/
  target/                   # Compiled code folder Maven creates
    generated-sources/
      protobuf/             # This is where your gRPC/protobuf java files would be compile to 
    ..
  pom.xml                   # The Maven pom file you added the dependencies and build configuration to 
```

Now you can start using `openOBD` in your `Maven` project!

## `C++`

> [!Note]
> Jifeline Networks already compiles the `openOBD` protocol to C++, but this is not publicly accessible (yet). The example below
> is used by Jifeline Networks, and is aimed towards a Linux operating system. The result with other operating systems may vary.

To compile the `openOBD` protocol to C++ you need to compile the tooling from source. For this example we will use `CMake` to build
the `gRPC` tooling.

To compile the proto files you'll need the [protoc binary](https://github.com/protocolbuffers/protobuf/releases/tag/v31.1). 
The protoc binary uses a plugin structure to be able to compile proto files to various languages. First we'll compile the C++ plugin.

First clone the `gRPC` git repository (supplying a valid `gRPC` version) and create the `CMake` folders.

```bash
git clone --recurse-submodules -b $GRPC_VERSION --depth 1 --shallow-submodules https://github.com/grpc/grpc
mkdir -p grpc/cmake/build
```

Execute `cmake` for the project within the created build folder. Afterwards execute `make`.

```bash
cmake ../..
make
```

This results in various plugins being build for `gRPC`. The one we are after is the `cpp` plugin. Move this to a location that
is in your operating system's `PATH` variable. This way the protoc binary is able to find it.

Finally compile the proto files to `C++` (this uses the same folder structure as the `Python` example).

```bash
find -name "*.proto" -exec protoc --proto_path=. --cpp_out=./output "{}" \;
find -name "*Services.proto" -exec protoc --proto_path=. --grpc-cpp_out==./output "{}" \;
```

Now you have all the files necessary to use `openOBD` in your C++ project!